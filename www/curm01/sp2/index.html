<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Michaela Čurillová">
    <meta name="description" content="TO-DO App helps you manage your tasks, add deadlines to your Google Calendar and listen to Spotify">
    <meta name="keywords" content="to-do, tasks, deadline, google calendar, spotify">
    <title>TO-DO LIST</title>
    <script src="./js/main.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.slim.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <link href="./css/style.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@100;200;400;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    
</head>

<body>
    <header>
        <div class="top-panel">
            <div class="top-panel-heading">
                <h1>TO-DO LIST</h1></div>
            <div class="row-playing">
                currently playing: 
                <div class="spot-player"><iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DX8Uebhn9wzrS?utm_source=generator" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe></div>
            </div>
            <div class="row-date" id="row-date">date: </div>
            <div id="date"></div>
        </div>
    </header>
        <div class="loader"></div>
    <main>
        <div class="main">
                <div class="main-tasks" id="main-tasks">
                    <h2>TASKS</h2>
                    <form id="tasks-form">
                        <input type="text" name="tasks-input" id="tasks-input" size="50">
                        <input type="submit" id="tasks-addButton" value="Add task">
                    </form>
                
                    <section class="task-list">
                        <div id="tasks"></div>
                    </section>
                </div>   
                <div class="calendar">
                    <h2>CALENDAR</h2>
                    <div id="authorize-div">
                        <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
                        <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>
                    
                        <pre id="content" style="white-space: pre-wrap;"></pre>
                    
                        <script type="text/javascript">
                          /* exported gapiLoaded */
                          /* exported gisLoaded */
                          /* exported handleAuthClick */
                          /* exported handleSignoutClick */
                    
                          // TODO(developer): Set to client ID and API key from the Developer Console
                          const CLIENT_ID = '592978563326-1lb16k4lf5bd1c3rdecbnfg866pflcvt.apps.googleusercontent.com';
                          const API_KEY = 'AIzaSyDMrS6TtnTMpEpr7rr4gnNV54DNui7lIEw';
                    
                          // Discovery doc URL for APIs used by the quickstart
                          const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
                    
                          // Authorization scopes required by the API; multiple scopes can be
                          // included, separated by spaces.
                          const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
                    
                          let tokenClient;
                          let gapiInited = false;
                          let gisInited = false;
                    
                          // document.getElementById('authorize_button').style.visibility = 'hidden';
                          // document.getElementById('signout_button').style.visibility = 'hidden';
                    
                          /**
                           * Callback after api.js is loaded.
                           */
                          function gapiLoaded() {
                            gapi.load('client', initializeGapiClient);
                          }
                    
                          /**
                           * Callback after the API client is loaded. Loads the
                           * discovery doc to initialize the API.
                           */
                          async function initializeGapiClient() {
                            await gapi.client.init({
                              apiKey: API_KEY,
                              discoveryDocs: [DISCOVERY_DOC],
                            });
                            gapiInited = true;
                            maybeEnableButtons();
                          }
                    
                          /**
                           * Callback after Google Identity Services are loaded.
                           */
                          function gisLoaded() {
                            tokenClient = google.accounts.oauth2.initTokenClient({
                              client_id: CLIENT_ID,
                              scope: SCOPES,
                              callback: '', // defined later
                            });
                            gisInited = true;
                            maybeEnableButtons();
                          }
                    
                          /**
                           * Enables user interaction after all libraries are loaded.
                           */
                          function maybeEnableButtons() {
                            if (gapiInited && gisInited) {
                              document.getElementById('authorize_button').style.visibility = 'visible';
                            }
                          }
                    
                          /**
                           *  Sign in the user upon button click.
                           */
                          function handleAuthClick() {
                            tokenClient.callback = async (resp) => {
                              if (resp.error !== undefined) {
                                throw (resp);
                              }
                              document.getElementById('signout_button').style.visibility = 'visible';
                              document.getElementById('authorize_button').innerText = 'Refresh';
                              await listUpcomingEvents();
                            };
                    
                            if (gapi.client.getToken() === null) {
                              // Prompt the user to select a Google Account and ask for consent to share their data
                              // when establishing a new session.
                              tokenClient.requestAccessToken({prompt: 'consent'});
                            } else {
                              // Skip display of account chooser and consent dialog for an existing session.
                              tokenClient.requestAccessToken({prompt: ''});
                            }
                          }
                    
                          /**
                           *  Sign out the user upon button click.
                           */
                          function handleSignoutClick() {
                            const token = gapi.client.getToken();
                            if (token !== null) {
                              google.accounts.oauth2.revoke(token.access_token);
                              gapi.client.setToken('');
                              document.getElementById('content').innerText = '';
                              document.getElementById('authorize_button').innerText = 'Authorize';
                              document.getElementById('signout_button').style.visibility = 'hidden';
                            }
                          }
                    
                          /**
                           * Print the summary and start datetime/date of the next ten events in
                           * the authorized user's calendar. If no events are found an
                           * appropriate message is printed.
                           */
                          async function listUpcomingEvents() {
                            let response;
                            try {
                              const request = {
                                'calendarId': 'primary',
                                'timeMin': (new Date()).toISOString(),
                                'showDeleted': false,
                                'singleEvents': true,
                                'maxResults': 10,
                                'orderBy': 'startTime',
                              };
                              response = await gapi.client.calendar.events.list(request);
                            } catch (err) {
                              document.getElementById('content').innerText = err.message;
                              return;
                            }
                    
                            const events = response.result.items;
                            if (!events || events.length == 0) {
                              document.getElementById('content').innerText = 'No events found.';
                              return;
                            }
                            // Flatten to string to display
                            const output = events.reduce(
                                (str, event) => `${str}${event.summary} (${event.start.dateTime || event.start.date})\n`,
                                'Events:\n');
                            document.getElementById('content').innerText = output;
                          }
                        </script>
                        <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
                        <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
                    </div>
           
                </div>
                <div id="app"></div>
        </div>
    </main>
    <footer>
        <div class="footer-main">
            <p>Copyright &copy<a href="mailto:curm01@vse.cz"> Michaela Čurillová</a></p>
        </div>
    </footer>
</body>
</html>